import React, { useState, useRef } from 'react';
import { Camera, Upload, BookOpen, Star, ThumbsUp, ThumbsDown, Loader2, ExternalLink } from 'lucide-react';

export default function LittleLibraryRecommender() {
  const [image, setImage] = useState(null);
  const [imagePreview, setImagePreview] = useState(null);
  const [goodreadsData, setGoodreadsData] = useState('');
  const [goodreadsConnected, setGoodreadsConnected] = useState(false);
  const [goodreadsScreenshot, setGoodreadsScreenshot] = useState(null);
  const [goodreadsScreenshotPreview, setGoodreadsScreenshotPreview] = useState(null);
  const [analyzingScreenshot, setAnalyzingScreenshot] = useState(false);
  const [analyzing, setAnalyzing] = useState(false);
  const [results, setResults] = useState(null);
  const [error, setError] = useState('');
  const fileInputRef = useRef(null);
  const goodreadsInputRef = useRef(null);

  const handleImageUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      setImage(file);
      const reader = new FileReader();
      reader.onloadend = () => {
        setImagePreview(reader.result);
      };
      reader.readAsDataURL(file);
      setResults(null);
      setError('');
    }
  };

  const handleGoodreadsScreenshot = (e) => {
    const file = e.target.files[0];
    if (file) {
      setGoodreadsScreenshot(file);
      const reader = new FileReader();
      reader.onloadend = () => {
        setGoodreadsScreenshotPreview(reader.result);
      };
      reader.readAsDataURL(file);
    }
  };

  const analyzeGoodreadsScreenshot = async () => {
    if (!goodreadsScreenshot) {
      setError('Please upload a screenshot first');
      return;
    }

    setAnalyzingScreenshot(true);
    setError('');

    try {
      const reader = new FileReader();
      reader.onloadend = async () => {
        const base64Data = reader.result;
        const base64Image = base64Data.split(',')[1];
        
        // Detect media type from the data URL
        let media_type = 'image/jpeg';
        if (base64Data.startsWith('data:image/png')) {
          media_type = 'image/png';
        } else if (base64Data.startsWith('data:image/webp')) {
          media_type = 'image/webp';
        } else if (base64Data.startsWith('data:image/gif')) {
          media_type = 'image/gif';
        }

        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 2000,
            messages: [
              {
                role: 'user',
                content: [
                  {
                    type: 'image',
                    source: {
                      type: 'base64',
                      media_type: media_type,
                      data: base64Image
                    }
                  },
                  {
                    type: 'text',
                    text: `This is a screenshot from someone's Goodreads account showing their book ratings, shelves, or recommendations.

Please extract their reading preferences by analyzing:
- Book titles and authors visible in the screenshot
- Star ratings (if visible)
- Genres or categories shown
- Any patterns in their reading taste

Create a comprehensive summary of their reading preferences that will help match them with books from little libraries.

Write a natural, detailed summary that includes:
1. Specific book titles and authors you can see
2. The genres or categories shown
3. Any rating patterns (if visible)
4. The types of books they seem to enjoy

Be as detailed and specific as possible. Include every book title and author you can read clearly.`
                  }
                ]
              }
            ]
          })
        });

        const data = await response.json();
        
        console.log('Screenshot analysis response:', data);
        
        if (data.content && data.content.length > 0) {
          // Extract text from all content blocks
          const fullResponse = data.content
            .map(item => (item.type === "text" ? item.text : ""))
            .filter(Boolean)
            .join("\n")
            .trim();
          
          if (fullResponse && fullResponse.length > 20) {
            setGoodreadsData(fullResponse);
            setGoodreadsConnected(true);
            setError('');
          } else {
            setError('Could not extract enough information from the screenshot. Please try a clearer image with visible book titles, or enter preferences manually.');
          }
        } else if (data.error) {
          setError('API Error: ' + (data.error.message || 'Unknown error'));
        } else {
          setError('Could not analyze the screenshot. Please try a clearer image with visible book titles and ratings, or enter preferences manually.');
        }
      };

      reader.onerror = () => {
        setError('Error reading screenshot file. Please try again.');
      };

      reader.readAsDataURL(goodreadsScreenshot);
    } catch (err) {
      console.error('Screenshot analysis error:', err);
      setError('Error analyzing screenshot: ' + err.message + '. Please try entering preferences manually.');
    } finally {
      setAnalyzingScreenshot(false);
    }
  };

  const analyzeLibrary = async () => {
    if (!image) {
      setError('Please upload a photo of a little library');
      return;
    }

    if (!goodreadsData.trim()) {
      setError('Please provide some information about books you\'ve enjoyed');
      return;
    }

    setAnalyzing(true);
    setError('');
    setResults(null);

    try {
      // Convert image to base64
      const reader = new FileReader();
      reader.onloadend = async () => {
        const base64Image = reader.result.split(',')[1];

        // Call Claude API to analyze the image and match with preferences
        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 1000,
            messages: [
              {
                role: 'user',
                content: [
                  {
                    type: 'image',
                    source: {
                      type: 'base64',
                      media_type: 'image/jpeg',
                      data: base64Image
                    }
                  },
                  {
                    type: 'text',
                    text: `Analyze this photo of a "little library" (neighborhood book sharing box) and identify any visible book titles and authors you can read from the spines or covers.

Then, based on this person's reading preferences and history, honestly assess whether ANY of these books would genuinely interest them:

${goodreadsData}

IMPORTANT: Be honest and selective. It's perfectly fine (and often better) to recommend ZERO books if nothing truly matches their taste. Don't recommend books just to be nice - only recommend books you genuinely think they'll enjoy based on their preferences. Most little libraries won't have great matches, and that's okay.

Guidelines:
- Only recommend books that are a STRONG match (3+ stars potential)
- If nothing matches well, leave "recommendations" as an empty array
- Be honest about mismatches - it's helpful for them to know what to skip
- If the user loves literary fiction and you see romance novels, say there's nothing for them
- Quality over quantity - recommending nothing is better than recommending mediocre matches

Please respond ONLY with valid JSON (no markdown, no preamble) in this exact format:
{
  "booksIdentified": [
    {
      "title": "Book Title",
      "author": "Author Name",
      "confidence": "high/medium/low"
    }
  ],
  "overallAssessment": "A brief honest take on whether this little library has anything for this reader",
  "recommendations": [
    {
      "title": "Book Title",
      "author": "Author Name",
      "reason": "Brief explanation of why this matches their preferences",
      "rating": 4
    }
  ],
  "notRecommended": [
    {
      "title": "Book Title",
      "author": "Author Name",
      "reason": "Brief explanation of why this doesn't match"
    }
  ]
}`
                  }
                ]
              }
            ]
          })
        });

        const data = await response.json();
        
        if (data.content && data.content[0] && data.content[0].text) {
          let jsonText = data.content[0].text.trim();
          // Remove markdown code blocks if present
          jsonText = jsonText.replace(/```json\n?/g, '').replace(/```\n?/g, '');
          
          try {
            const parsedResults = JSON.parse(jsonText);
            setResults(parsedResults);
          } catch (parseError) {
            console.error('Parse error:', parseError);
            setError('Could not parse the analysis results. Please try again.');
          }
        } else {
          setError('No response from analysis service');
        }
      };

      reader.onerror = () => {
        setError('Error reading image file');
      };

      reader.readAsDataURL(image);
    } catch (err) {
      console.error('Analysis error:', err);
      setError('Error analyzing image: ' + err.message);
    } finally {
      setAnalyzing(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-amber-50 via-orange-50 to-rose-50 p-6">
      <div className="max-w-4xl mx-auto">
        {/* Header */}
        <div className="text-center mb-8">
          <div className="flex items-center justify-center gap-3 mb-3">
            <BookOpen className="w-10 h-10 text-amber-700" />
            <h1 className="text-4xl font-bold text-amber-900">Little Library Scout</h1>
          </div>
          <p className="text-amber-700 text-lg">
            Discover your next great read from neighborhood book boxes
          </p>
        </div>

        {/* Main Content */}
        <div className="bg-white rounded-2xl shadow-xl p-8 mb-6">
          {/* Step 1: Upload Image */}
          <div className="mb-8">
            <h2 className="text-2xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
              <Camera className="w-6 h-6 text-amber-600" />
              Step 1: Upload Little Library Photo
            </h2>
            
            <div className="border-3 border-dashed border-amber-300 rounded-xl p-8 text-center bg-amber-50/50">
              <input
                ref={fileInputRef}
                type="file"
                accept="image/*"
                onChange={handleImageUpload}
                className="hidden"
              />
              
              {imagePreview ? (
                <div className="space-y-4">
                  <img 
                    src={imagePreview} 
                    alt="Little library" 
                    className="max-h-64 mx-auto rounded-lg shadow-md"
                  />
                  <button
                    onClick={() => fileInputRef.current?.click()}
                    className="px-6 py-2 bg-amber-100 text-amber-800 rounded-lg hover:bg-amber-200 transition-colors"
                  >
                    Change Photo
                  </button>
                </div>
              ) : (
                <button
                  onClick={() => fileInputRef.current?.click()}
                  className="flex flex-col items-center gap-3 mx-auto"
                >
                  <Upload className="w-16 h-16 text-amber-400" />
                  <span className="text-lg text-gray-700">Click to upload a photo</span>
                  <span className="text-sm text-gray-500">JPG, PNG, or HEIC</span>
                </button>
              )}
            </div>
          </div>

          {/* Step 2: Goodreads Info */}
          <div className="mb-8">
            <h2 className="text-2xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
              <Star className="w-6 h-6 text-amber-600" />
              Step 2: Share Your Reading Preferences
            </h2>
            
            {goodreadsConnected ? (
              <div className="space-y-4">
                <div className="p-6 bg-green-50 rounded-xl border-2 border-green-300">
                  <div className="flex items-center justify-between mb-3">
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center">
                        <BookOpen className="w-6 h-6 text-white" />
                      </div>
                      <div>
                        <h3 className="font-semibold text-gray-800">Reading Preferences Set</h3>
                        <p className="text-sm text-gray-600">Ready to analyze little libraries</p>
                      </div>
                    </div>
                    <button
                      onClick={() => {
                        setGoodreadsConnected(false);
                        setGoodreadsData('');
                        setGoodreadsScreenshot(null);
                        setGoodreadsScreenshotPreview(null);
                      }}
                      className="text-sm text-gray-500 hover:text-gray-700 underline"
                    >
                      Edit
                    </button>
                  </div>
                  <div className="bg-white p-4 rounded-lg text-sm text-gray-700 max-h-48 overflow-y-auto">
                    {goodreadsData}
                  </div>
                </div>
              </div>
            ) : (
              <div className="space-y-6">
                {/* Screenshot Upload Option */}
                <div className="p-6 bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl border-2 border-amber-200">
                  <div className="flex items-start gap-3 mb-4">
                    <Camera className="w-6 h-6 text-amber-600 flex-shrink-0 mt-1" />
                    <div>
                      <h3 className="font-semibold text-lg text-gray-800 mb-2">üì∏ Upload Goodreads Screenshot (Quick!)</h3>
                      <p className="text-sm text-gray-600 mb-3">
                        Take a screenshot of your Goodreads shelves, ratings, or "My Books" page and we'll extract your preferences automatically.
                      </p>
                      <p className="text-xs text-gray-500 mb-4">
                        üí° Best results: screenshot showing book titles, authors, and star ratings
                      </p>
                    </div>
                  </div>

                  <input
                    ref={goodreadsInputRef}
                    type="file"
                    accept="image/*"
                    onChange={handleGoodreadsScreenshot}
                    className="hidden"
                  />

                  {goodreadsScreenshotPreview ? (
                    <div className="space-y-4">
                      <img 
                        src={goodreadsScreenshotPreview} 
                        alt="Goodreads screenshot" 
                        className="max-h-64 mx-auto rounded-lg shadow-md border-2 border-amber-300"
                      />
                      <div className="flex gap-3">
                        <button
                          onClick={analyzeGoodreadsScreenshot}
                          disabled={analyzingScreenshot}
                          className="flex-1 py-3 bg-amber-500 text-white rounded-lg font-semibold hover:bg-amber-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                        >
                          {analyzingScreenshot ? (
                            <>
                              <Loader2 className="w-5 h-5 animate-spin" />
                              Analyzing Screenshot...
                            </>
                          ) : (
                            <>
                              <Star className="w-5 h-5" />
                              Extract Preferences
                            </>
                          )}
                        </button>
                        <button
                          onClick={() => {
                            setGoodreadsScreenshot(null);
                            setGoodreadsScreenshotPreview(null);
                          }}
                          className="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors"
                        >
                          Remove
                        </button>
                      </div>
                    </div>
                  ) : (
                    <button
                      onClick={() => goodreadsInputRef.current?.click()}
                      className="w-full py-4 border-3 border-dashed border-amber-300 rounded-lg bg-white hover:bg-amber-50 transition-colors flex items-center justify-center gap-3"
                    >
                      <Upload className="w-6 h-6 text-amber-500" />
                      <span className="text-gray-700 font-medium">Click to Upload Screenshot</span>
                    </button>
                  )}
                </div>

                {/* Divider */}
                <div className="flex items-center gap-4">
                  <div className="flex-1 h-px bg-gray-300"></div>
                  <span className="text-sm text-gray-500 font-medium">OR</span>
                  <div className="flex-1 h-px bg-gray-300"></div>
                </div>

                {/* Manual Input Option */}
                <div className="space-y-4">
                  <div className="p-4 bg-amber-50 rounded-xl border-2 border-amber-200">
                    <div className="flex gap-3 mb-3">
                      <BookOpen className="w-5 h-5 text-amber-600 flex-shrink-0 mt-1" />
                      <div className="text-sm text-gray-700">
                        <p className="font-semibold mb-2">‚úçÔ∏è Type Your Preferences</p>
                        <p className="text-gray-600">Manually enter books you've loved and genres you enjoy</p>
                      </div>
                    </div>
                  </div>

                  <textarea
                    value={goodreadsData}
                    onChange={(e) => setGoodreadsData(e.target.value)}
                    placeholder="Paste your favorite books and reading preferences here. For example:

üìö Books I loved (5 stars):
‚Ä¢ The Night Circus by Erin Morgenstern
‚Ä¢ Project Hail Mary by Andy Weir
‚Ä¢ Circe by Madeline Miller

üìö Books I enjoyed (4 stars):
‚Ä¢ The Martian by Andy Weir
‚Ä¢ The Invisible Life of Addie LaRue by V.E. Schwab

üé≠ Genres I love:
‚Ä¢ Literary fiction, Science fiction, Magical realism, Historical fiction

üëé Not a fan of:
‚Ä¢ Romance novels, Mystery/thrillers, Self-help

‚úçÔ∏è Favorite authors:
‚Ä¢ Neil Gaiman, Ursula K. Le Guin, Ted Chiang, N.K. Jemisin

The more specific you are, the better the recommendations!"
                    className="w-full h-64 p-4 border-2 border-amber-200 rounded-xl focus:border-amber-400 focus:outline-none resize-none text-gray-700 text-sm font-mono"
                  />
                  
                  <button
                    onClick={() => {
                      if (goodreadsData.trim()) {
                        setGoodreadsConnected(true);
                        setError('');
                      } else {
                        setError('Please enter your reading preferences first');
                      }
                    }}
                    disabled={!goodreadsData.trim()}
                    className="px-6 py-3 bg-amber-500 text-white rounded-lg font-semibold hover:bg-amber-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    Save Preferences
                  </button>
                </div>
              </div>
            )}
          </div>

          {/* Analyze Button */}
          <button
            onClick={analyzeLibrary}
            disabled={analyzing || !image || !goodreadsData.trim()}
            className="w-full py-4 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-xl font-semibold text-lg hover:from-amber-600 hover:to-orange-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-3 shadow-lg"
          >
            {analyzing ? (
              <>
                <Loader2 className="w-6 h-6 animate-spin" />
                Analyzing Your Little Library...
              </>
            ) : (
              <>
                <BookOpen className="w-6 h-6" />
                Find My Next Read
              </>
            )}
          </button>

          {/* Error Message */}
          {error && (
            <div className="mt-4 p-4 bg-red-50 border-2 border-red-200 rounded-xl text-red-700">
              {error}
            </div>
          )}
        </div>

        {/* Results */}
        {results && (
          <div className="space-y-6">
            {/* Overall Assessment */}
            {results.overallAssessment && (
              <div className="bg-white rounded-2xl shadow-xl p-8 border-2 border-amber-200">
                <h2 className="text-2xl font-semibold text-gray-800 mb-3">
                  üìñ Overall Assessment
                </h2>
                <p className="text-lg text-gray-700 leading-relaxed">
                  {results.overallAssessment}
                </p>
              </div>
            )}

            {/* Books Identified */}
            <div className="bg-white rounded-2xl shadow-xl p-8">
              <h2 className="text-2xl font-semibold text-gray-800 mb-4">
                üìö Books I Found ({results.booksIdentified?.length || 0})
              </h2>
              {results.booksIdentified && results.booksIdentified.length > 0 ? (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {results.booksIdentified.map((book, idx) => (
                    <div key={idx} className="p-4 bg-gray-50 rounded-lg border-2 border-gray-200">
                      <div className="font-semibold text-gray-800">{book.title}</div>
                      <div className="text-sm text-gray-600">{book.author}</div>
                      <div className="text-xs text-gray-500 mt-1">
                        Confidence: {book.confidence}
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <p className="text-gray-600">No books could be clearly identified in this photo.</p>
              )}
            </div>

            {/* Recommendations */}
            {results.recommendations && results.recommendations.length > 0 ? (
              <div className="bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl shadow-xl p-8 border-2 border-green-200">
                <h2 className="text-2xl font-semibold text-green-800 mb-4 flex items-center gap-2">
                  <ThumbsUp className="w-7 h-7" />
                  Worth Picking Up! ({results.recommendations.length})
                </h2>
                <div className="space-y-4">
                  {results.recommendations.map((book, idx) => (
                    <div key={idx} className="p-6 bg-white rounded-xl shadow-md border-2 border-green-300">
                      <div className="flex items-start justify-between mb-2">
                        <div>
                          <div className="font-bold text-lg text-gray-800">{book.title}</div>
                          <div className="text-gray-600">{book.author}</div>
                        </div>
                        <div className="flex gap-1">
                          {[...Array(book.rating || 0)].map((_, i) => (
                            <Star key={i} className="w-5 h-5 fill-yellow-400 text-yellow-400" />
                          ))}
                        </div>
                      </div>
                      <p className="text-gray-700 mt-3 leading-relaxed">{book.reason}</p>
                    </div>
                  ))}
                </div>
              </div>
            ) : (
              <div className="bg-gradient-to-br from-gray-50 to-slate-50 rounded-2xl shadow-xl p-8 border-2 border-gray-300">
                <h2 className="text-2xl font-semibold text-gray-700 mb-4 flex items-center gap-2">
                  ü§∑ Nothing Jumps Out
                </h2>
                <p className="text-lg text-gray-600 leading-relaxed">
                  Based on your reading taste, there's nothing in this little library that seems like a strong match. Better to save your reading time for books you'll really enjoy!
                </p>
                <p className="text-sm text-gray-500 mt-4">
                  üí° Keep checking other little libraries in your neighborhood - you never know what treasures you'll find next.
                </p>
              </div>
            )}

            {/* Not Recommended */}
            {results.notRecommended && results.notRecommended.length > 0 && (
              <div className="bg-gray-50 rounded-2xl shadow-xl p-8 border-2 border-gray-200">
                <h2 className="text-2xl font-semibold text-gray-700 mb-4 flex items-center gap-2">
                  <ThumbsDown className="w-7 h-7" />
                  Probably Skip These
                </h2>
                <div className="space-y-3">
                  {results.notRecommended.map((book, idx) => (
                    <div key={idx} className="p-4 bg-white rounded-lg">
                      <div className="font-semibold text-gray-800">{book.title}</div>
                      <div className="text-sm text-gray-600 mb-2">{book.author}</div>
                      <p className="text-sm text-gray-600">{book.reason}</p>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        )}

        {/* Footer */}
        <div className="text-center mt-8 text-sm text-gray-600">
          <p>üí° Tip: Take clear photos with good lighting for best results</p>
        </div>
      </div>
    </div>
  );
}
